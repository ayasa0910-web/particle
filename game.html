<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>シンプルなシューティングゲーム</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        canvas {
            border: 2px solid #333;
            background-color: #000;
        }
        .controls {
            margin-top: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas" width="480" height="640"></canvas>

<div class="controls">
    <button id="startButton">Start / Retry (Enterキー)</button> 
    <button id="pauseButton">Pause / Resume (Enterキー)</button>
</div>

<script>
    // -----------------------------------------------------
    // 1. セットアップ
    // -----------------------------------------------------
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startButton = document.getElementById('startButton');
    const pauseButton = document.getElementById('pauseButton');

    // ゲーム変数
    let gameLoop;
    let isGameOver = false;
    let isPaused = false;
    let isGameStarted = false; 

    // プレイヤー（自機）の初期設定
    const initialPlayer = { x: canvas.width / 2 - 25, y: canvas.height - 70, width: 50, height: 50, speed: 8 };
    let player = { ...initialPlayer };

    // 弾丸の配列
    let bullets = []; 
    let enemyBullets = []; 

    // 敵の配列
    let enemies = [];
    let enemySpawnRate = 1000;
    let lastEnemySpawnTime = 0;
    const initialEnemySpawnRate = 1000; 

    // スコア
    let score = 0;

    // キー入力の状態
    const keys = {
        ArrowLeft: false,
        ArrowRight: false,
        Space: false,
        Enter: false
    };

    // -----------------------------------------------------
    // 1.5. ゲームのリセット関数
    // -----------------------------------------------------
    const resetGame = () => {
        // 全てのゲーム変数を初期化
        player = { ...initialPlayer };
        bullets = [];
        enemyBullets = [];
        enemies = [];
        score = 0;
        isGameOver = false;
        isPaused = false;
        isGameStarted = true; // ゲームをスタート状態に
        enemySpawnRate = initialEnemySpawnRate;
        lastEnemySpawnTime = 0;

        // ボタンの表示を切り替え
        startButton.style.display = 'none';
        pauseButton.style.display = 'inline-block';
        pauseButton.textContent = 'Pause / Resume (Enterキー)';

        // ゲームループを再開
        gameLoop = requestAnimationFrame(gameUpdate);
    };


    // -----------------------------------------------------
    // 2. イベントリスナー
    // -----------------------------------------------------
    document.addEventListener('keydown', (e) => {
        if (keys.hasOwnProperty(e.code)) {
            keys[e.code] = true;
        }
        
        // ★★★ エンターキーの統合処理 ★★★
        if (e.code === 'Enter') {
            if (!isGameStarted || isGameOver) {
                // ゲーム開始前 または ゲームオーバー時 -> 開始/リトライ
                if (!isGameStarted || isGameOver) {
                    resetGame();
                }
            } else if (isGameStarted && !isGameOver) {
                // プレイ中 -> 一時停止/再開
                isPaused = !isPaused;
            }
        }
    });

    document.addEventListener('keyup', (e) => {
        if (keys.hasOwnProperty(e.code)) {
            keys[e.code] = false;
        }
    });

    // スタート・リトライボタン
    startButton.addEventListener('click', resetGame);

    // 一時停止ボタン
    pauseButton.addEventListener('click', () => {
        if (isGameStarted && !isGameOver) {
            isPaused = !isPaused;
        }
    });

    // 自機の弾発射
    let lastShotTime = 0;
    const fireRate = 100;

    const fireBullet = (timestamp) => {
        if (keys.Space && timestamp - lastShotTime > fireRate) {
            const bullet = {
                x: player.x + player.width / 2 - 2.5,
                y: player.y,
                width: 5,
                height: 10,
                speed: 10
            };
            bullets.push(bullet);
            lastShotTime = timestamp;
        }
    };


    // -----------------------------------------------------
    // 3. 描画関数
    // -----------------------------------------------------

    const drawPlayer = () => { ctx.fillStyle = 'cyan'; ctx.fillRect(player.x, player.y, player.width, player.height); };
    const drawBullets = () => { ctx.fillStyle = 'yellow'; bullets.forEach(b => { ctx.fillRect(b.x, b.y, b.width, b.height); }); };
    const drawEnemyBullets = () => { ctx.fillStyle = 'magenta'; enemyBullets.forEach(b => { ctx.fillRect(b.x, b.y, b.width, b.height); }); };
    const drawEnemies = () => { ctx.fillStyle = 'red'; enemies.forEach(e => { ctx.fillRect(e.x, e.y, e.width, e.height); }); };
    const drawScore = () => { ctx.fillStyle = 'white'; ctx.font = '24px Arial'; ctx.textAlign = 'left'; ctx.fillText(`SCORE: ${score}`, 10, 30); };

    // スタート画面の描画
    const drawStartScreen = () => {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = 'white';
        ctx.font = '40px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('SHMUP GAME', canvas.width / 2, canvas.height / 2 - 50);

        ctx.font = '20px Arial';
        ctx.fillText('Press ENTER or Space to Start', canvas.width / 2, canvas.height / 2 + 20);
        ctx.fillText('Use ← → to move, Space to shoot', canvas.width / 2, canvas.height / 2 + 60);
        ctx.fillText('Press ENTER to Pause', canvas.width / 2, canvas.height / 2 + 90);
    }

    const drawPaused = () => {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'white';
        ctx.font = '48px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('PAUSED', canvas.width / 2, canvas.height / 2);
    }

    // ゲームオーバー画面の描画
    const drawGameOver = () => {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = 'white';
        ctx.font = '48px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2 - 30);
        ctx.font = '30px Arial';
        ctx.fillText(`Final Score: ${score}`, canvas.width / 2, canvas.height / 2 + 30);
        ctx.font = '24px Arial';
        ctx.fillText('Press ENTER to Retry', canvas.width / 2, canvas.height / 2 + 90);
    };


    // -----------------------------------------------------
    // 4. 更新関数
    // -----------------------------------------------------

    const updatePlayer = () => {
        if (keys.ArrowLeft) { player.x -= player.speed; }
        if (keys.ArrowRight) { player.x += player.speed; }
        player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

        // スタート画面でSpaceキーを押した場合もゲーム開始
        if (!isGameStarted && keys.Space) {
            resetGame();
        }
    };

    const updateBullets = () => {
        bullets.forEach(b => { b.y -= b.speed; });
        bullets = bullets.filter(b => b.y + b.height > 0);
    };

    const updateEnemyBullets = () => {
        enemyBullets.forEach(b => { b.y += b.speed; });
        enemyBullets = enemyBullets.filter(b => b.y < canvas.height);
    };

    const updateEnemies = (timestamp) => {
        // 敵の生成
        if (timestamp - lastEnemySpawnTime > enemySpawnRate) {
            const enemy = {
                x: Math.random() * (canvas.width - 50),
                y: -50,
                width: 40,
                height: 40,
                speed: 1.5,
                lastShotTime: timestamp
            };
            enemies.push(enemy);
            lastEnemySpawnTime = timestamp;
            if (enemySpawnRate > 300) { enemySpawnRate -= 5; }
        }

        // 敵の移動と攻撃
        enemies.forEach(e => {
            e.y += e.speed;

            // 敵の攻撃ロジック
            if (Math.random() < 0.008 && timestamp - e.lastShotTime > 1000) {
                const enemyBullet = {
                    x: e.x + e.width / 2 - 2,
                    y: e.y + e.height,
                    width: 4,
                    height: 8,
                    speed: 5
                };
                enemyBullets.push(enemyBullet);
                e.lastShotTime = timestamp;
            }
        });

        // 画面下端に到達した敵
        enemies = enemies.filter(e => e.y < canvas.height);
    };

    const checkCollision = (rect1, rect2) => {
        return rect1.x < rect2.x + rect2.width && rect1.x + rect1.width > rect2.x &&
               rect1.y < rect2.y + rect2.height && rect1.y + rect1.height > rect2.y;
    };

    const handleCollisions = () => {
        // 1. 自機の弾と敵の衝突
        bullets.forEach((bullet, bIndex) => {
            enemies.forEach((enemy, eIndex) => {
                if (checkCollision(bullet, enemy)) {
                    bullets.splice(bIndex, 1);
                    enemies.splice(eIndex, 1);
                    score += 10;
                    return;
                }
            });
        });

        // 2. プレイヤーと敵の弾の衝突
        enemyBullets.forEach((eBullet, ebIndex) => {
            if (checkCollision(player, eBullet)) {
                isGameOver = true;
                enemyBullets.splice(ebIndex, 1);
                return;
            }
        });

        // 3. プレイヤーと敵本体の衝突
        enemies.forEach(enemy => {
            if (checkCollision(player, enemy)) {
                isGameOver = true;
            }
        });
    };


    // -----------------------------------------------------
    // 5. メインループ
    // -----------------------------------------------------

    const gameUpdate = (timestamp) => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (!isGameStarted) {
            // ゲーム開始前
            drawStartScreen();
            startButton.style.display = 'inline-block';
            pauseButton.style.display = 'none';
            gameLoop = requestAnimationFrame(gameUpdate);
            updatePlayer();
            return;
        }

        if (isGameOver) {
            // ゲームオーバー処理
            drawEnemies(); drawEnemyBullets(); drawPlayer(); drawBullets(); drawScore();
            drawGameOver();
            startButton.style.display = 'inline-block'; 
            startButton.textContent = 'RETRY';
            pauseButton.style.display = 'none';
            cancelAnimationFrame(gameLoop);
            return;
        }

        if (isPaused) {
            // 一時停止中
            drawEnemies(); drawEnemyBullets(); drawBullets(); drawPlayer(); drawScore();
            drawPaused();
            gameLoop = requestAnimationFrame(gameUpdate);
            return;
        }

        // ゲーム実行中
        
        // 更新
        fireBullet(timestamp);
        updatePlayer();
        updateBullets();
        updateEnemyBullets();
        updateEnemies(timestamp);
        handleCollisions();

        // 描画
        drawEnemies();
        drawEnemyBullets();
        drawBullets();
        drawPlayer();
        drawScore();
        
        // 次のフレームを要求
        gameLoop = requestAnimationFrame(gameUpdate);
    };

    // 初期起動
    pauseButton.style.display = 'none'; // 初期状態では非表示
    gameLoop = requestAnimationFrame(gameUpdate);
</script>

</body>
</html>

